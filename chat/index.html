<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="0;url=/chat/chat.html">
    <title>Redirecting to chat...</title>
</head>
<body>
<p>Redirecting to <a href="/chat/chat.html">chat</a>...</p>
</body>
</html>

        .chat-header h1 {
            color: var(--accent-red);
            font-size: 28px;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: var(--primary-bg);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.3s ease-in;
            position: relative;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .username {
            font-weight: bold;
            color: var(--accent-red);
        }

        .timestamp {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .message-content {
            word-wrap: break-word;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            font-size: 16px;
        }

        .chat-input:focus {
            border-color: var(--accent-red);
            outline: none;
        }

        .send-button {
            background-color: var(--accent-red);
            color: var(--text-primary);
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .send-button:hover {
            background-color: var(--accent-red-dark);
        }

        .send-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .auth-required {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .auth-required button {
            background-color: var(--accent-red);
            color: var(--text-primary);
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .user-email {
            color: var(--text-secondary);
        }

        .logout-btn {
            background-color: transparent;
            border: 1px solid var(--accent-red);
            color: var(--text-primary);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }

        .logout-btn:hover {
            background-color: var(--accent-red);
        }

        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .auth-form-container {
            background-color: var(--primary-bg);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .auth-tab.active {
            border-bottom: 2px solid var(--accent-red);
            color: var(--accent-red);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-form input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 16px;
        }

        .auth-form input:focus {
            border-color: var(--accent-red);
            outline: none;
        }

        .auth-form button {
            width: 100%;
            padding: 12px 20px;
            background-color: var(--accent-red);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .auth-form button:hover {
            background-color: var(--accent-red-dark);
        }

        .auth-error {
            color: var(--accent-red);
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            min-height: 20px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
        }

        .auto-clear-notice {
            background-color: rgba(229, 9, 20, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            color: var(--text-primary);
        }

        /* Admin Controls */
        .admin-controls {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .flag-button, .delete-button {
            padding: 2px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .flag-button {
            background-color: #ff9800;
            color: white;
        }

        .flag-button.flagged {
            background-color: #f44336;
        }

        .delete-button {
            background-color: #f44336;
            color: white;
        }

        .flagged-message {
            opacity: 0.7;
            background-color: rgba(244, 67, 54, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--accent-red);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--accent-red-dark);
        }
    </style>
</head>
<body>
    <!-- Header - Now static (not hovering) -->
    <header>
        <div class="logo">Blood<span>Vine</span></div>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="/prices/">Prices</a></li>
            </ul>
        </nav>
        <div class="auth-buttons">
            <button id="loginBtn" class="auth-btn">Login</button>
            <button id="signupBtn" class="auth-btn">Sign Up</button>
        </div>
        <div class="mobile-menu">
            <i class="fas fa-bars"></i>
        </div>
    </header>

    <!-- Chat Container -->
    <div class="chat-container">
        <div class="chat-header">
            <h1>Chat Room</h1>
            <div id="adminBadge" style="display: none;">
                <span class="admin-badge">Admin</span>
            </div>
        </div>

        <div id="userInfo" class="user-info" style="display: none;">
            <span id="userDisplayName"></span>
            <span id="userEmail" class="user-email"></span>
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>

        <div id="chatMessages" class="chat-messages"></div>

        <div class="chat-input-container">
            <input type="text" id="messageInput" class="chat-input" placeholder="Type your message..." />
            <button id="sendButton" class="send-button" disabled>Send</button>
        </div>

        <div id="authRequired" class="auth-required" style="display: none;">
            <p>Please log in to participate in the chat</p>
            <button onclick="showAuthModal()">Login / Sign Up</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-form-container">
            <button class="close-modal" id="closeModal">&times;</button>
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Login</div>
                <div class="auth-tab" id="signupTab">Sign Up</div>
            </div>
            
            <div class="auth-form active" id="loginForm">
                <div class="auth-error" id="loginError"></div>
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button id="loginSubmit">Login</button>
            </div>
            
            <div class="auth-form" id="signupForm">
                <div class="auth-error" id="signupError"></div>
                <input type="text" id="signupUsername" placeholder="Username" required>
                <input type="email" id="signupEmail" placeholder="Email" required>
                <input type="password" id="signupPassword" placeholder="Password" required>
                <button id="signupSubmit">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer> 
        <div class="footer-content">
            <div class="footer-column">
                <h3>Explore</h3>
                <ul>
                    <li><a href="index.html">All Anime</a></li>
                    <li><a href="index.html">Recently Added</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Community</h3>
                <ul>
                    <li><a href="forums.html">Forums</a></li>
                    <li><a href="#">Discord Server (Under construction)</a></li>
                    <li><a href="events.html">Events</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Support</h3>
                <ul>
                    <li><a href="/contact/">Contact Us</a></li>
                    <li><a href="/faq/">FAQ</a></li>
                    <li><a href="/privacy-policy/">Privacy Policy</a></li>
                    <li><a href="/terms-of-service/">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Connect With Us</h3>
                <p>Stay updated with the latest dark anime news and releases.</p>
                <div class="social-icons">
                    <a href="https://x.com"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.youtube.com/@BloodVineCC"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>
        <div class="copyright">
            <p>&copy; 2025 BloodVine. All rights reserved. | Chat</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFN3SVxLU5OFl3ki2H4qeFYvm2rT47dQk",
            authDomain: "lukew96-82bb6.firebaseapp.com",
            databaseURL: "https://lukew96-82bb6-default-rtdb.firebaseio.com",
            projectId: "lukew96-82bb6",
            storageBucket: "lukew96-82bb6.firebasestorage.app",
            messagingSenderId: "1041074415159",
            appId: "1:1041074415159:web:d9a8d1330673d3ad9781b2"
        };


        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Get references to Firebase services
        const auth = firebase.auth();
        const database = firebase.database();
        // Admin configuration: update these with admin emails or UIDs who are allowed to run /clear
        // You can add owner emails here, or populate ADMIN_UIDS with specific user IDs.
        const ADMIN_EMAILS = [
            'lukew296@proton.me'
        ];
        const ADMIN_UIDS = [
            'CanonLight#4057'
        ];

        // Listen for when Firebase messages are cleared
        database.ref('messages').on('value', (snapshot) => {
            if (!snapshot.exists()) {
                displaySystemMessage("Chat has been automatically cleared (12-hour auto-cleanup).");
            }
        });

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const authRequired = document.getElementById('authRequired');
        const userInfo = document.getElementById('userInfo');
        const userDisplayName = document.getElementById('userDisplayName');
        const userEmail = document.getElementById('userEmail');
        
        // Auth modal elements
        const authModal = document.getElementById('authModal');
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const closeModal = document.getElementById('closeModal');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const showSignupBtn = document.getElementById('showSignupBtn');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Form elements
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginSubmit = document.getElementById('loginSubmit');
        const loginError = document.getElementById('loginError');
        
        const signupUsername = document.getElementById('signupUsername');
        const signupEmail = document.getElementById('signupEmail');
        const signupPassword = document.getElementById('signupPassword');
        const signupSubmit = document.getElementById('signupSubmit');
        const signupError = document.getElementById('signupError');
        
        // Auth modal functionality
        function showAuthModal() {
            authModal.style.display = 'flex';
        }
        
        function hideAuthModal() {
            authModal.style.display = 'none';
            // Clear forms and errors
            loginEmail.value = '';
            loginPassword.value = '';
            loginError.textContent = '';
            signupUsername.value = '';
            signupEmail.value = '';
            signupPassword.value = '';
            signupError.textContent = '';
        }
        
        function showLoginForm() {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
        }
        
        function showSignupForm() {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.classList.add('active');
            loginForm.classList.remove('active');
        }
        
        // Event listeners for auth modal
        closeModal.addEventListener('click', hideAuthModal);
        showLoginBtn.addEventListener('click', () => {
            showAuthModal();
            showLoginForm();
        });
        showSignupBtn.addEventListener('click', () => {
            showAuthModal();
            showSignupForm();
        });
        loginBtn.addEventListener('click', () => {
            showAuthModal();
            showLoginForm();
        });
        signupBtn.addEventListener('click', () => {
            showAuthModal();
            showSignupForm();
        });
        loginTab.addEventListener('click', showLoginForm);
        signupTab.addEventListener('click', showSignupForm);
        
        // Close modal when clicking outside
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                hideAuthModal();
            }
        });
        
        // Authentication state observer
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                authRequired.style.display = 'none';
                userInfo.style.display = 'flex';
                messageInput.disabled = false;
                sendButton.disabled = false;
                
                // Update user info
                userDisplayName.textContent = user.displayName || user.email.split('@')[0];
                userEmail.textContent = user.email;
                
                loadMessages();
            } else {
                // User is signed out
                authRequired.style.display = 'block';
                userInfo.style.display = 'none';
                messageInput.disabled = true;
                sendButton.disabled = true;
                chatMessages.innerHTML = '';
                chatMessages.appendChild(authRequired);
            }
        });
        // Debug: log auth changes
        auth.onIdTokenChanged(user => {
            console.log('auth state changed (id token):', user && { uid: user.uid, email: user.email });
        });
        
        // Login functionality
        loginSubmit.addEventListener('click', () => {
            const email = loginEmail.value;
            const password = loginPassword.value;
            
            if (!email || !password) {
                loginError.textContent = 'Please fill in all fields';
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    hideAuthModal();
                })
                .catch(error => {
                    console.error('Login error:', error);
                    if (error.code === 'auth/invalid-email') {
                        loginError.textContent = 'Invalid email address';
                    } else if (error.code === 'auth/user-disabled') {
                        loginError.textContent = 'This account has been disabled';
                    } else if (error.code === 'auth/user-not-found') {
                        loginError.textContent = 'No account found with this email';
                    } else if (error.code === 'auth/wrong-password') {
                        loginError.textContent = 'Incorrect password';
                    } else {
                        loginError.textContent = 'Login failed. Please try again.';
                    }
                });
        });
        
        // Sign up functionality
        signupSubmit.addEventListener('click', () => {
            const username = signupUsername.value;
            const email = signupEmail.value;
            const password = signupPassword.value;
            
            if (!username || !email || !password) {
                signupError.textContent = 'Please fill in all fields';
                return;
            }
            
            if (password.length < 6) {
                signupError.textContent = 'Password must be at least 6 characters';
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Update user profile with username
                    return userCredential.user.updateProfile({
                        displayName: username
                    });
                })
                .then(() => {
                    hideAuthModal();
                })
                .catch(error => {
                    console.error('Sign up error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        signupError.textContent = 'This email is already registered';
                    } else if (error.code === 'auth/invalid-email') {
                        signupError.textContent = 'Invalid email address';
                    } else if (error.code === 'auth/weak-password') {
                        signupError.textContent = 'Password is too weak';
                    } else {
                        signupError.textContent = 'Sign up failed. Please try again.';
                    }
                });
        });
        
        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
        
        // Send message
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '') return;

            const user = auth.currentUser;
            if (!user) return;

            // Special command: /clear â€” clear all messages from the database
            if (message === '/clear') {
                const isAdmin = (user.email && ADMIN_EMAILS.includes(user.email)) || (user.uid && ADMIN_UIDS.includes(user.uid));
                if (!isAdmin) {
                    displaySystemMessage('You do not have permission to clear the chat.');
                    messageInput.value = '';
                    return;
                }

                if (!confirm('Are you sure you want to clear the chat? This will permanently delete all messages.')) {
                    messageInput.value = '';
                    return;
                }

                // Clear the displayed messages immediately for snappier UI
                clearDisplayedMessages();

                 // Remove all messages from the database
                database.ref('messages').remove()
                    .then(() => {
                        displaySystemMessage('Chat has been cleared by ' + (user.displayName || user.email || 'an admin') + '.');
                        messageInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error clearing chat:', error);
                        // Inform the user; displayed messages are already cleared locally.
                        displaySystemMessage('Failed to clear chat on the server. Messages may reappear.');
                        alert('Failed to clear chat. Please try again.');
                    });

                return;
            }

            const messageData = {
                text: message,
                username: user.displayName || (user.email ? user.email.split('@')[0] : 'Anonymous'),
                userId: user.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Push normal message to Firebase
            database.ref('messages').push(messageData)
                .then(() => {
                    console.log('message pushed', messageData);
                    messageInput.value = '';
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                });
        }

        function displaySystemMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system-message';
            
            const date = new Date();
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="username">System</span>
                    <span class="timestamp">${timeString}</span>
                </div>
                <div class="message-content">${text}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove displayed messages from the chat container while keeping the auth prompt (if present)
        function clearDisplayedMessages() {
            const authReq = document.getElementById('authRequired');
            // Remove all children except the authRequired element
            Array.from(chatMessages.children).forEach(child => {
                if (authReq && child === authReq) return;
                chatMessages.removeChild(child);
            });
            // Ensure the authRequired prompt is visible to unauthenticated users
            if (authReq && authReq.parentElement !== chatMessages) {
                chatMessages.appendChild(authReq);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Load and listen for new messages
        function loadMessages() {
            // Remove any previous listeners to avoid duplicate handlers
            database.ref('messages').off();

            const messagesRef = database.ref('messages').orderByChild('timestamp').limitToLast(50);

            // Debug: log initial snapshot size
            messagesRef.once('value').then(snap => {
                console.log('initial messages count:', snap.numChildren());
            }).catch(err => console.error('once value error', err));

            messagesRef.on('child_added', snapshot => {
                console.log('child_added', snapshot.key, snapshot.val());
                const message = snapshot.val();
                displayMessage(message);

                // Auto-scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

            // Optional: listen for child_removed to update UI
            messagesRef.on('child_removed', snapshot => {
                console.log('child_removed', snapshot.key);
                // If database removed everything, clear display
                database.ref('messages').once('value').then(snap => {
                    if (!snap.exists()) {
                        clearDisplayedMessages(); 
                        displaySystemMessage('Chat has been cleared.');
                    }
                });
            });
        }
        
        function displayMessage(message) {
            try {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';

                const header = document.createElement('div');
                header.className = 'message-header';

                const userSpan = document.createElement('span');
                userSpan.className = 'username';
                userSpan.textContent = message.username || 'Anonymous';

                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'timestamp';
                let timeString = '';
                if (message && message.timestamp && !isNaN(Number(message.timestamp))) {
                    const date = new Date(Number(message.timestamp));
                    timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                timestampSpan.textContent = timeString;

                header.appendChild(userSpan);
                header.appendChild(timestampSpan);

                const content = document.createElement('div');
                content.className = 'message-content';
                // Use textContent to avoid HTML injection and rendering issues
                content.textContent = message.text || '';

                messageElement.appendChild(header);
                messageElement.appendChild(content);

                // Admin controls - visible only to admins
                const user = auth.currentUser;
                const isAdmin = (user && user.email && ADMIN_EMAILS.includes(user.email)) || (user && user.uid && ADMIN_UIDS.includes(user.uid));
                if (isAdmin) {
                    const adminControls = document.createElement('div');
                    adminControls.className = 'admin-controls';

                    const flagButton = document.createElement('button');
                    flagButton.className = 'flag-button';
                    flagButton.textContent = 'Flag';
                    flagButton.onclick = () => {
                        // Toggle flagged state
                        const isFlagged = messageElement.classList.toggle('flagged-message');
                        flagButton.classList.toggle('flagged', isFlagged);

                        // Optionally, update the message in the database to reflect the flagged state
                        database.ref('messages/' + snapshot.key).update({ flagged: isFlagged });
                    };

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-button';
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = () => {
                        if (confirm('Are you sure you want to delete this message?')) {
                            // Remove message from database
                            database.ref('messages/' + snapshot.key).remove()
                                .then(() => {
                                    messageElement.remove();
                                })
                                .catch(error => {
                                    console.error('Error deleting message:', error);
                                    alert('Failed to delete message. Please try again.');
                                });
                        }
                    };

                    adminControls.appendChild(flagButton);
                    adminControls.appendChild(deleteButton);
                    messageElement.appendChild(adminControls);
                }

                chatMessages.appendChild(messageElement);
            } catch (err) {
                console.error('displayMessage error', err, message);
            }
        }
    </script>
</body>
</html>
